@page "/list"
@inject Journal.Services.IJournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JS

@code {
    /// <summary>
    /// This component provides a comprehensive list view of personal journal entries
    /// with advanced filtering capabilities including keyword search, date ranges,
    /// mood categorization, and tag-based filtering with server-side pagination.
    /// </summary>
}

<h1 class="page-title">All Entries</h1>

<!-- 🔍 SEARCH & FILTER BAR -->
<div class="filter-bar">
    <input placeholder="Search content or category..."
           @bind="SearchText" />

    <input placeholder="Search by tags..."
           @bind="SearchTag" />

    <input type="date" @bind="FromDate" />
    <input type="date" @bind="ToDate" />

    <select @bind="SelectedMood">
        <option value="">All moods</option>
        <option value="😊 Happy">😊 Happy</option>
        <option value="🤩 Excited">🤩 Excited</option>
        <option value="😌 Relaxed">😌 Relaxed</option>
        <option value="🙏 Grateful">🙏 Grateful</option>
        <option value="😐 Calm">😐 Calm</option>
        <option value="😢 Sad">😢 Sad</option>
        <option value="😰 Stressed">😰 Stressed</option>
        <option value="😟 Anxious">😟 Anxious</option>
    </select>

    <button class="btn-primary" @onclick="ApplyFilters">
        Apply
    </button>
</div>

@if (UsedTags.Any())
{
    <div class="quick-tags">
        <span class="quick-tags-label">Filter by Tag:</span>
        @foreach (var tag in UsedTags)
        {
            <button class="quick-tag @(SearchTag == tag ? "active" : "")" 
                    @onclick="() => ToggleQuickTag(tag)">
                #@tag
            </button>
        }
    </div>
}

@if (Loading)
{
    <p>Loading entries...</p>
}
else if (!Entries.Any())
{
    <p>No entries found.</p>
}
else
{
    <div class="entries-list">
        @foreach (var entry in Entries)
        {
            <article class="entry-card"
                     @onclick="() => EditEntry(entry.Id)"
                     style="cursor: pointer;">

                <div class="entry-header">
                    <span class="entry-date">
                        @entry.EntryDate.ToString("MMMM dd, yyyy")
                    </span>
                    <span class="entry-mood">@entry.PrimaryMood</span>
                    <span class="visibility-badge @(entry.IsPublic ? "public" : "private")">
                        @(entry.IsPublic ? "Public" : "Private")
                    </span>
                </div>

                <h2 class="entry-title">@entry.Category</h2>

                <p class="entry-excerpt">@entry.ContentPreview</p>

                @if (entry.Tags.Any())
                {
                    <div class="entry-tags">
                        @foreach (var tag in entry.Tags)
                        {
                            <span class="tag">#@tag</span>
                        }
                    </div>
                }

                <div class="entry-footer">
                    <span>@entry.WordCount words</span>

                    <button class="delete-icon-btn"
                            @onclick="() => ConfirmDelete(entry.Id)"
                            @onclick:stopPropagation="true">
                        Delete
                    </button>
                </div>
            </article>
        }
    </div>

    <!-- 📄 PAGINATION -->
    <div class="pagination">
        <button disabled="@(Page == 1)"
                @onclick="() => ChangePage(Page - 1)">
            Prev
        </button>

        <span>Page @Page of @TotalPages</span>

        <button disabled="@(Page == TotalPages)"
                @onclick="() => ChangePage(Page + 1)">
            Next
        </button>
    </div>
}

@code {
    private bool Loading = true;
    private List<Journal.Models.JournalEntryDisplayModel> Entries = new();

    // 🔍 Filters
    private string? SearchText;
    private string? SearchTag;
    private DateTime? FromDate;
    private DateTime? ToDate;
    private string? SelectedMood;

    // 📄 Pagination
    private int Page = 1;
    private int PageSize = 5;
    private int TotalPages = 1;
    private List<string> UsedTags = new();

    protected override async Task OnInitializedAsync()
    {
        UsedTags = await JournalService.GetAllTagsAsync();
        await LoadEntries();
    }

    /// <summary>
    /// Retrieves journal entries from the service based on the current filter state.
    /// Implements server-side pagination to efficiently handle large result sets.
    /// </summary>
    private async Task LoadEntries()
    {
        Loading = true;

        var result = await JournalService.SearchAsync(
            SearchText,
            FromDate,
            ToDate,
            SelectedMood,
            SearchTag,
            Page,
            PageSize);

        Entries = result.Items;
        TotalPages = result.TotalPages;

        Loading = false;
    }

    /// <summary>
    /// Applies all selected filters and resets pagination to the first page.
    /// </summary>
    private async Task ApplyFilters()
    {
        Page = 1;
        await LoadEntries();
    }

    private async Task ChangePage(int page)
    {
        Page = page;
        await LoadEntries();
    }

    private void EditEntry(int id)
    {
        Navigation.NavigateTo($"/write/{id}");
    }

    private async Task ConfirmDelete(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>(
            "confirm",
            "Are you sure you want to delete this journal entry?"
        );

        if (confirmed)
        {
            await JournalService.DeleteAsync(id);
            await LoadEntries();
        }
    }

    /// <summary>
    /// Toggles a specific tag filter on or off for quick filtering.
    /// If the tag is already active, it deselects it; otherwise, it activates it.
    /// </summary>
    private async Task ToggleQuickTag(string tag)
    {
        if (SearchTag == tag)
            SearchTag = null;
        else
            SearchTag = tag;
            
        await ApplyFilters();
    }
}
