@page "/"
@inject Journal.Services.IJournalService JournalService
@inject NavigationManager Navigation

<main class="dashboard">

    <!-- HERO -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">@Greeting</h1>
            <p class="hero-subtitle">@DateTime.Today.ToString("MMMM dd, yyyy")</p>
            <button class="cta-button" @onclick='() => Navigation.NavigateTo("/write")'>
                New Entry
            </button>
        </div>
    </section>

    <!-- STATS -->
    <section class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">🔥</div>
            <div class="stat-value">@Streak</div>
            <div class="stat-label">Current Streak</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">⭐</div>
            <div class="stat-value">@LongestStreak</div>
            <div class="stat-label">Longest Streak</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">📝</div>
            <div class="stat-value">@TotalEntries</div>
            <div class="stat-label">Total Entries</div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">📊</div>
            <div class="stat-value">@AvgWords</div>
            <div class="stat-label">Avg Words</div>
        </div>
    </section>

    <!-- ANALYTICS -->
    <section class="analytics">

        <div class="analytics-row">

            <!-- MOOD DISTRIBUTION -->
            <div class="chart-card">
                <h3 class="card-title">Mood Distribution</h3>

                <div class="mood-category-bars">
                    <div class="mood-bar-item">
                        <span class="mood-label">Positive</span>
                        <div class="mood-bar-container">
                            <div class="mood-bar positive" style="width: @CategoryPercentage(PositiveCount)%"></div>
                        </div>
                        <span class="mood-percentage">@CategoryPercentage(PositiveCount).ToString("0")%</span>
                    </div>
                    <div class="mood-bar-item">
                        <span class="mood-label">Neutral</span>
                        <div class="mood-bar-container">
                            <div class="mood-bar neutral" style="width: @CategoryPercentage(NeutralCount)%"></div>
                        </div>
                        <span class="mood-percentage">@CategoryPercentage(NeutralCount).ToString("0")%</span>
                    </div>
                    <div class="mood-bar-item">
                        <span class="mood-label">Negative</span>
                        <div class="mood-bar-container">
                            <div class="mood-bar negative" style="width: @CategoryPercentage(NegativeCount)%"></div>
                        </div>
                        <span class="mood-percentage">@CategoryPercentage(NegativeCount).ToString("0")%</span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(MostFrequentMood))
                {
                    <div class="frequent-mood-info">
                        <span class="info-label">Most Frequent Mood:</span>
                        <span class="info-value">@MostFrequentMood</span>
                    </div>
                }
            </div>

            <!-- CATEGORY PIE (Tag Breakdown) -->
            <div class="chart-card">
                <h3 class="card-title">Category Breakdown</h3>

                @if (!CategoryStats.Any())
                {
                    <p>No data available</p>
                }
                else
                {
                    <div class="pie-wrapper">
                        <svg width="200" height="200" viewBox="0 0 36 36"
                             class="pie-chart">
                            @{
                                double offset = 0;
                                int index = 0;
                            }

                            @foreach (var item in CategoryStats)
                            {
                                <circle r="16"
                                        cx="18"
                                        cy="18"
                                        fill="transparent"
                                        stroke="@PieColors[index % PieColors.Count]"
                                        stroke-width="4"
                                        stroke-dasharray="@item.Percentage 100"
                                        stroke-dashoffset="@offset" />
                                offset -= item.Percentage;
                                index++;
                            }
                        </svg>

                        <div class="pie-legend">
                            @for (int i = 0; i < CategoryStats.Count; i++)
                            {
                                <div class="legend-item">
                                    <span class="legend-color"
                                          style="background:@PieColors[i % PieColors.Count]"></span>
                                    <span>
                                        @CategoryStats[i].Category
                                        (@CategoryStats[i].Percentage%)
                                    </span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="analytics-row">
            <!-- MOST USED TAGS -->
            <div class="chart-card full-width">
                <h3 class="card-title">Most Frequent Tags</h3>
                @if (!TagCounts.Any())
                {
                    <p>No tags used yet.</p>
                }
                else
                {
                    <div class="tag-cloud">
                        @foreach (var tag in TagCounts.OrderByDescending(x => x.Value).Take(15))
                        {
                            <span class="cloud-tag" style="font-size: @(0.8 + (tag.Value * 0.2))rem; opacity: @(0.4 + (tag.Value * 0.1 > 0.6 ? 0.6 : tag.Value * 0.1));">
                                #@tag.Key <span class="tag-count">(@tag.Value)</span>
                            </span>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- RECENT ENTRIES -->
        <div class="analytics-row">
            <div class="chart-card full-width">
                <h3 class="card-title">Recent Entries</h3>

                @if (!RecentEntries.Any())
                {
                    <p>No entries yet.</p>
                }
                else
                {
                    <div class="recent-entries">
                        @foreach (var entry in RecentEntries)
                        {
                            <div class="entry-preview"
                                 @onclick="() => NavigateToEntry(entry.Id)">
                                <div class="entry-date">
                                    @entry.EntryDate.ToString("MMM dd, yyyy")
                                </div>
                                <div class="entry-title">
                                    @(string.IsNullOrEmpty(entry.Category)
                                        ? "Untitled"
                                        : entry.Category)
                                </div>
                                <div class="entry-mood">
                                    @entry.PrimaryMood
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

    </section>
</main>

@code {

    private List<Journal.Models.JournalEntryDisplayModel> AllEntries = new();
    private List<Journal.Models.JournalEntryDisplayModel> RecentEntries = new();

    private int TotalEntries;
    private int AvgWords;
    private int Streak;
    private int LongestStreak;

    private int PositiveCount;
    private int NeutralCount;
    private int NegativeCount;
    private string MostFrequentMood = "";

    private readonly string[] PositiveMoods = { "😊 Happy", "🤩 Excited", "😌 Relaxed", "🙏 Grateful", "💪 Confident" };
    private readonly string[] NeutralMoods = { "😐 Calm", "💭 Thoughtful", "🧐 Curious", "🌅 Nostalgic", "😑 Bored" };
    private readonly string[] NegativeMoods = { "😢 Sad", "😠 Angry", "😰 Stressed", "😔 Lonely", "😟 Anxious" };

    private Dictionary<string, int> MoodCounts = new();
    private Dictionary<string, int> TagCounts = new();

    private List<CategoryPieItem> CategoryStats = new();

    private readonly List<string> PieColors = new()
    {
        "var(--chart-1)",
        "var(--chart-2)",
        "var(--chart-3)",
        "var(--chart-4)",
        "var(--chart-5)"
    };

    private string Greeting =>
        DateTime.Now.Hour < 12 ? "Good Morning" :
        DateTime.Now.Hour < 17 ? "Good Afternoon" :
        "Good Evening";

    protected override async Task OnInitializedAsync()
    {
        AllEntries = await JournalService.GetAllAsync();
        RecentEntries = AllEntries.Take(3).ToList();

        TotalEntries = AllEntries.Count;
        AvgWords = TotalEntries == 0
            ? 0
            : (int)AllEntries.Average(e => e.WordCount);

        CalculateMoodDistribution();
        CalculateCategoryPie();
        CalculateTagStats();
        CalculateStreaks();
    }

    private void CalculateMoodDistribution()
    {
        PositiveCount = 0;
        NeutralCount = 0;
        NegativeCount = 0;
        MoodCounts.Clear();

        foreach (var entry in AllEntries)
        {
            var mood = entry.PrimaryMood;
            if (string.IsNullOrWhiteSpace(mood)) continue;

            // Update Counts for Most Frequent
            if (!MoodCounts.ContainsKey(mood)) MoodCounts[mood] = 0;
            MoodCounts[mood]++;

            // Update Categories
            if (PositiveMoods.Contains(mood)) PositiveCount++;
            else if (NeutralMoods.Contains(mood)) NeutralCount++;
            else if (NegativeMoods.Contains(mood)) NegativeCount++;
        }

        MostFrequentMood = MoodCounts.OrderByDescending(x => x.Value).FirstOrDefault().Key ?? "N/A";
    }

    private double CategoryPercentage(int count)
    {
        if (TotalEntries == 0) return 0;
        return (double)count / TotalEntries * 100;
    }

    private void CalculateCategoryPie()
    {
        if (!AllEntries.Any()) return;

        CategoryStats = AllEntries
            .GroupBy(e => string.IsNullOrWhiteSpace(e.Category)
                ? "Other"
                : e.Category)
            .Select(g => new CategoryPieItem
            {
                Category = g.Key,
                Percentage = Math.Round(
                    (double)g.Count() / TotalEntries * 100, 1)
            })
            .OrderByDescending(c => c.Percentage)
            .ToList();
    }

    private void CalculateTagStats()
    {
        TagCounts = AllEntries
            .SelectMany(e => e.Tags)
            .GroupBy(t => t)
            .ToDictionary(g => g.Key, g => g.Count());
    }

    private void CalculateStreaks()
    {
        if (!AllEntries.Any()) return;

        var dates = AllEntries
            .Select(e => e.EntryDate.Date)
            .Distinct()
            .OrderByDescending(d => d)
            .ToList();

        Streak = 0;
        var today = DateTime.Today;

        foreach (var d in dates)
        {
            if (d == today.AddDays(-Streak))
                Streak++;
            else
                break;
        }

        LongestStreak = 1;
        int temp = 1;

        for (int i = 1; i < dates.Count; i++)
        {
            if ((dates[i - 1] - dates[i]).Days == 1)
            {
                temp++;
                LongestStreak = Math.Max(LongestStreak, temp);
            }
            else
            {
                temp = 1;
            }
        }
    }

    private void NavigateToEntry(int id)
    {
        Navigation.NavigateTo($"/write/{id}");
    }

    private class CategoryPieItem
    {
        public string Category { get; set; } = "";
        public double Percentage { get; set; }
    }
}
