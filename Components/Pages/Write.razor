@page "/write"
@page "/write/{Id:int}"
@using Journal.Data
@using Journal.Entities
@using Microsoft.EntityFrameworkCore
@implements IDisposable
@inject Journal.Services.IJournalService JournalService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject AppDbContext Db
@inject AuthStateService Auth

@if (editContext == null)
{
    <div class="loading-container">
        <div class="spinner"></div>
        <p>Initializing editor...</p>
    </div>
}
else
{
    <EditForm EditContext="editContext" OnSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

    <main class="editor-container">
        <div class="editor-wrapper">

            <!-- Date / Time -->
            <div class="editor-header">
                <div class="entry-date">
                    <h1 class="date-display">@(IsEdit ? model.EntryDate.ToString("MMMM dd, yyyy") : DateTime.Today.ToString("MMMM dd, yyyy"))</h1>
                    <p class="time-display">@DateTime.Now.ToString("hh:mm tt")</p>
                </div>
            </div>

            <!-- Entry Content -->
            <div class="entry-form">
                <div id="@EditorId" class="entry-content"></div>

                <div class="word-count">
                    @WordCount words
                </div>
            </div>

            <!-- Metadata -->
            <div class="metadata-section">

                <!-- Primary Mood -->
                <div class="metadata-card">
                    <h3 class="metadata-title">Primary Mood</h3>
                    <div class="mood-category-group">
                        <h4 class="mood-category-title">Positive</h4>
                        <div class="mood-grid">
                            @foreach (var mood in PositiveMoods)
                            {
                                <button type="button" class="mood-item @(model.PrimaryMood == mood ? "selected" : "")" @onclick="() => model.PrimaryMood = mood">@mood</button>
                            }
                        </div>
                    </div>
                    <div class="mood-category-group">
                        <h4 class="mood-category-title">Neutral</h4>
                        <div class="mood-grid">
                            @foreach (var mood in NeutralMoods)
                            {
                                <button type="button" class="mood-item @(model.PrimaryMood == mood ? "selected" : "")" @onclick="() => model.PrimaryMood = mood">@mood</button>
                            }
                        </div>
                    </div>
                    <div class="mood-category-group">
                        <h4 class="mood-category-title">Negative</h4>
                        <div class="mood-grid">
                            @foreach (var mood in NegativeMoods)
                            {
                                <button type="button" class="mood-item @(model.PrimaryMood == mood ? "selected" : "")" @onclick="() => model.PrimaryMood = mood">@mood</button>
                            }
                        </div>
                    </div>
                </div>

                <!-- Secondary Moods -->
                <div class="metadata-card">
                    <h3 class="metadata-title">Secondary Moods (Optional)</h3>
                    <div class="mood-category-group">
                        <h4 class="mood-category-title">Positive</h4>
                        <div class="mood-grid secondary">
                            @foreach (var mood in PositiveMoods)
                            {
                                <button type="button" class="mood-item small @(IsSecondarySelected(mood) ? "selected" : "")" @onclick="() => ToggleSecondaryMood(mood)">@mood</button>
                            }
                        </div>
                    </div>
                    <div class="mood-category-group">
                        <h4 class="mood-category-title">Neutral</h4>
                        <div class="mood-grid secondary">
                            @foreach (var mood in NeutralMoods)
                            {
                                <button type="button" class="mood-item small @(IsSecondarySelected(mood) ? "selected" : "")" @onclick="() => ToggleSecondaryMood(mood)">@mood</button>
                            }
                        </div>
                    </div>
                    <div class="mood-category-group">
                        <h4 class="mood-category-title">Negative</h4>
                        <div class="mood-grid secondary">
                            @foreach (var mood in NegativeMoods)
                            {
                                <button type="button" class="mood-item small @(IsSecondarySelected(mood) ? "selected" : "")" @onclick="() => ToggleSecondaryMood(mood)">@mood</button>
                            }
                        </div>
                    </div>
                </div>

                <!-- Category -->
                <div class="metadata-card">
                    <h3 class="metadata-title">Category</h3>
                    <select class="category-select" @bind="model.Category">
                        <option value="">Select Category</option>
                        <option value="Personal">Personal</option>
                        <option value="Work">Work</option>
                        <option value="Health">Health</option>
                        <option value="Relationships">Relationships</option>
                        <option value="Personal Growth">Personal Growth</option>
                        <option value="Other">Other...</option>
                    </select>

                    @if (model.Category == "Other")
                    {
                        <div class="custom-category-input">
                            <input type="text" @bind="CustomCategoryName" placeholder="Enter custom category..." class="tag-input" />
                        </div>
                    }
                </div>

                <!-- Visibility Toggle -->
                <div class="metadata-card">
                    <h3 class="metadata-title">Visibility</h3>
                    <div class="visibility-toggle">
                        <label class="switch">
                            <input type="checkbox" @bind="model.IsPublic">
                            <span class="slider round"></span>
                        </label>
                        <span class="visibility-label">@(model.IsPublic ? "Public (Visible to everyone)" : "Private (Only for you)")</span>
                    </div>
                </div>

                <!-- Tags Section -->
                <div class="metadata-card">
                    <h3 class="metadata-title">Tags (Optional)</h3>
                    
                    <div class="custom-tag-input">
                        <input type="text" @bind="CustomTagName" placeholder="Add custom tag..." @onkeyup="HandleTagKeyUp" />
                        <button type="button" class="add-tag-btn" @onclick="AddCustomTag">+</button>
                    </div>

                    <div class="tags-grid">
                        @foreach (var tag in AllPrebuiltTags)
                        {
                            <button type="button" 
                                    class="tag-item @(model.SelectedTags.Contains(tag) ? "selected" : "")"
                                    @onclick="() => ToggleTag(tag)">
                                @tag
                            </button>
                        }
                        @foreach (var tag in model.SelectedTags.Where(t => !AllPrebuiltTags.Contains(t)))
                        {
                            <button type="button" class="tag-item selected" @onclick="() => ToggleTag(tag)">
                                @tag <span class="remove-tag">×</span>
                            </button>
                        }
                    </div>
                </div>

                <!-- Actions -->
                <div class="metadata-card">
                    <div class="action-buttons">
                        <button type="submit" class="save-btn">
                            @(IsEdit ? "Update Entry" : "Save Today’s Entry")
                        </button>

                        @if (IsEdit)
                        {
                            <button type="button" class="delete-btn" @onclick="DeleteEntry">
                                Delete Entry
                            </button>
                        }
                    </div>

                    @if (Saved)
                    {
                        <p class="success-text">Entry saved successfully ✔</p>
                    }

                    @if (IsEdit)
                    {
                        <div class="entry-timestamps">
                            <p>Created: @model.CreatedAt.ToString("MMM dd, yyyy hh:mm tt")</p>
                            <p>Last Updated: @model.UpdatedAt.ToString("MMM dd, yyyy hh:mm tt")</p>
                        </div>
                    }
                </div>

            </div>
        </div>
    </main>
    </EditForm>
}

@code {
    [Parameter] public int? Id { get; set; }
    private Journal.Models.JournalEntryViewModel model = new();
    private EditContext? editContext;
    private bool Saved = false;
    private const string EditorId = "quill-editor";
    private bool _quillReady;
    private bool IsEdit => Id.HasValue;
    private DotNetObjectReference<Write>? _objRef;

    private readonly string[] PositiveMoods = { "😊 Happy", "🤩 Excited", "😌 Relaxed", "🙏 Grateful", "💪 Confident" };
    private readonly string[] NeutralMoods = { "😐 Calm", "💭 Thoughtful", "🧐 Curious", "🌅 Nostalgic", "😑 Bored" };
    private readonly string[] NegativeMoods = { "😢 Sad", "😠 Angry", "😰 Stressed", "😔 Lonely", "😟 Anxious" };

    // Helper to get all moods for certain logic if needed
    private IEnumerable<string> AllMoodOptions => PositiveMoods.Concat(NeutralMoods).Concat(NegativeMoods);

    private readonly string[] AllPrebuiltTags = 
    {
        "Work", "Career", "Studies", "Family", "Friends", "Relationships",
        "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies", "Travel", "Nature",
        "Finance", "Spirituality", "Birthday", "Holiday", "Vacation", "Celebration", "Exercise",
        "Reading", "Writing", "Cooking", "Meditation", "Yoga", "Music", "Shopping", "Parenting",
        "Projects", "Planning", "Reflection"
    };

    private string CustomTagName = "";
    private string CustomCategoryName = "";

    protected override async Task OnInitializedAsync()
    {
        // One-time initialization of the JS helper reference
        _objRef = DotNetObjectReference.Create(this);
    }

    /// <summary>
    /// Handles data loading whenever parameters (like Id) or the URL change.
    /// This is safer for redirects and same-component navigation.
    /// </summary>
    protected override async Task OnParametersSetAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        // Reset state for new load
        _quillReady = false; 
        StateHasChanged();

        if (Id.HasValue)
        {
            // Load specific entry by ID
            var existing = await JournalService.GetByIdAsync(Id.Value);
            if (existing != null)
            {
                model = existing;
                HandleCustomCategoryMapping();
            }
        }
        else if (query["date"] != null)
        {
            try 
            {
                if (DateTime.TryParse(query["date"], out DateTime selectedDate))
                {
                    var currentUserId = Auth.CurrentUser?.Id ?? 0;
                    var entry = await Db.JournalEntries
                        .FirstOrDefaultAsync(e => e.EntryDate.Date == selectedDate.Date && e.UserId == currentUserId);

                    if (entry != null)
                    {
                        // Redirect if an entry for this date already exists
                        Navigation.NavigateTo($"/write/{entry.Id}");
                        return;
                    }
                    
                    // Create new entry for the selected date
                    model = new Journal.Models.JournalEntryViewModel { EntryDate = selectedDate };
                }
            }
            catch (Exception)
            {
                // Graceful fallback for invalid date strings
                model = new();
            }
        }
        else
        {
            // Load or initialize "Today" entry
            var existing = await JournalService.GetTodayAsync();
            if (existing != null)
            {
                model = existing;
                HandleCustomCategoryMapping();
            }
            else 
            {
                model = new();
            }
        }

        // Initialize edit context once data is ready
        editContext = new EditContext(model);
        
        // If we are already rendered, we need to manually update Quill content
        if (Id.HasValue || query["date"] != null || true)
        {
            // Note: AfterRender handles the first set
            if (_quillReady)
            {
                await JS.InvokeVoidAsync("setQuillHtml", model.Content ?? string.Empty);
            }
        }
    }

    /// <summary>
    /// Handles mapping of "Other" category to the custom category text field.
    /// </summary>
    private void HandleCustomCategoryMapping()
    {
        var predefined = new[] { "Personal", "Work", "Health", "Relationships", "Personal Growth" };
        if (!string.IsNullOrEmpty(model.Category) && !predefined.Contains(model.Category))
        {
            CustomCategoryName = model.Category;
            model.Category = "Other";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && editContext != null)
        {
            // Initialize the Quill editor only after the container div is rendered
            await JS.InvokeVoidAsync("initQuill", EditorId, _objRef);
            _quillReady = true;
            await JS.InvokeVoidAsync("setQuillHtml", model.Content ?? string.Empty);
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void UpdateContent(string html)
    {
        model.Content = html;
        StateHasChanged();
    }

    private int WordCount =>
        string.IsNullOrWhiteSpace(model.Content)
            ? 0
            : System.Text.RegularExpressions.Regex.Replace(model.Content, "<.*?>", string.Empty)
                .Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;

    private bool IsSecondarySelected(string mood) =>
        model.SecondaryMood1 == mood || model.SecondaryMood2 == mood;

    private void ToggleSecondaryMood(string mood)
    {
        if (model.SecondaryMood1 == mood)
            model.SecondaryMood1 = null;
        else if (model.SecondaryMood2 == mood)
            model.SecondaryMood2 = null;
        else if (string.IsNullOrEmpty(model.SecondaryMood1))
            model.SecondaryMood1 = mood;
        else if (string.IsNullOrEmpty(model.SecondaryMood2))
            model.SecondaryMood2 = mood;
    }

    private void ToggleTag(string tag)
    {
        if (model.SelectedTags.Contains(tag))
            model.SelectedTags.Remove(tag);
        else
            model.SelectedTags.Add(tag);
    }

    private void AddCustomTag()
    {
        if (!string.IsNullOrWhiteSpace(CustomTagName))
        {
            var tag = CustomTagName.Trim();
            if (!model.SelectedTags.Contains(tag))
            {
                model.SelectedTags.Add(tag);
            }
            CustomTagName = "";
        }
    }

    private void HandleTagKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddCustomTag();
        }
    }

    private async Task HandleSubmit()
    {
        if (_quillReady)
        {
            model.Content = await JS.InvokeAsync<string>("getQuillHtml");
        }

        if (model.Category == "Other")
        {
            model.Category = CustomCategoryName;
        }

        if (editContext != null && editContext.Validate())
        {
            await JournalService.CreateOrUpdateAsync(model, Id);
            Saved = true;

            if (!IsEdit)
            {
                if (_quillReady)
                {
                    await JS.InvokeVoidAsync("setQuillHtml", string.Empty);
                }
                model = new();
                editContext = new EditContext(model);
            }

            await Task.Delay(3000);
            Saved = false;
            StateHasChanged();

            if (IsEdit)
            {
                Navigation.NavigateTo("/list");
            }
        }
    }

    private async Task DeleteEntry()
    {
        if (Id.HasValue)
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry?");
            if (confirmed)
            {
                await JournalService.DeleteAsync(Id.Value);
                Navigation.NavigateTo("/list");
            }
        }
    }

    public void Dispose()
    {
        _objRef?.Dispose();
    }
}
