@page "/settings"
@using Journal.Data
@using Journal.Entities

@inject Journal.Services.ThemeService ThemeService
@inject AppDbContext Db
@inject PinService PinService
@inject AuthStateService Auth
@inject NavigationManager Nav

<div class="settings-container">
    <h2 class="settings-title">Settings</h2>
    
    <div class="settings-section">
        <h3>Account Information</h3>
        <div class="account-form">
            <div class="form-group">
                <label>Username</label>
                <input type="text" class="form-control" @bind="EditUsername" placeholder="Username" />
            </div>
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" class="form-control" @bind="EditEmail" placeholder="Email" />
            </div>
            <div class="form-group">
                <label>New Password (Leave blank to keep current)</label>
                <input type="password" class="form-control" @bind="EditPassword" placeholder="New Password" />
            </div>
            
            @if (!string.IsNullOrEmpty(AccountMessage))
            {
                <div class="account-message @(AccountIsSuccess ? "success" : "error")">
                    @AccountMessage
                </div>
            }

            <button class="save-account-btn" @onclick="UpdateAccount">
                Update Profile
            </button>
        </div>
    </div>

<div class="settings-section">
    <h3>Change PIN</h3>

    @if (Step == 1)
    {
        <p>Enter current PIN</p>
        <PinPad Pin="@CurrentPin"
                PinChanged="v => CurrentPin = v"
                OnCompleted="VerifyCurrentPin" />
    }
    else if (Step == 2)
    {
        <p>Enter new PIN</p>
        <PinPad Pin="@NewPin"
                PinChanged="v => NewPin = v"
                OnCompleted="NextStep" />
    }
    else if (Step == 3)
    {
        <p>Confirm new PIN</p>
        <PinPad Pin="@ConfirmPin"
                PinChanged="v => ConfirmPin = v"
                OnCompleted="SavePin" />
    }

    @if (!string.IsNullOrEmpty(Message))
    {
        <p class="settings-message">@Message</p>
    }
</div>

<div class="settings-section">
    <h3>Security</h3>
    <div class="security-actions">
        <button class="lock-btn" @onclick="LockJournal">
            Lock Journal
        </button>
        <button class="logout-btn-danger" @onclick="LogOut">
            Log Out Completely
        </button>
    </div>
</div>

<div class="settings-section">
    <h3>Appearance</h3>
    <div class="theme-selector">
        <button class="theme-btn @(ThemeService.CurrentTheme == "light" ? "active" : "")" 
                @onclick='() => ThemeService.SetTheme("light")'>
            Light
        </button>
        <button class="theme-btn @(ThemeService.CurrentTheme == "dark" ? "active" : "")" 
                @onclick='() => ThemeService.SetTheme("dark")'>
            Dark
        </button>
    </div>
    </div>
</div>

@code {
    int Step = 1;

    string CurrentPin = "";
    string NewPin = "";
    string ConfirmPin = "";
    string Message = "";

    string EditUsername = "";
    string EditEmail = "";
    string EditPassword = "";
    string AccountMessage = "";
    bool AccountIsSuccess = false;

    protected override void OnInitialized()
    {
        if (Auth.CurrentUser != null)
        {
            EditUsername = Auth.CurrentUser.Username;
            EditEmail = Auth.CurrentUser.Email;
        }
    }

    void VerifyCurrentPin()
    {
        if (Auth.CurrentUser == null) return;

        if (Auth.CurrentUser.PinHash != PinService.HashPin(CurrentPin))
        {
            Message = "Incorrect PIN";
            CurrentPin = "";
            return;
        }

        Message = "";
        Step = 2;
    }

    void NextStep()
    {
        Step = 3;
    }

    async Task SavePin()
    {
        if (NewPin != ConfirmPin)
        {
            Message = "PINs do not match";
            NewPin = ConfirmPin = "";
            Step = 2;
            return;
        }

        if (Auth.CurrentUser != null)
        {
            var user = Db.Users.Find(Auth.CurrentUser.Id);
            if (user != null)
            {
                user.PinHash = PinService.HashPin(NewPin);
                await Db.SaveChangesAsync();
                
                // Update local session state too
                Auth.Login(user); 

                Message = "PIN updated successfully";
                Auth.Logout(); // Force relogin after PIN change for security
                Nav.NavigateTo("/authentication", true);
            }
        }
    }

    void LockJournal()
    {
        Auth.Lock();
        Nav.NavigateTo("/authentication", true);
    }

    void LogOut()
    {
        Auth.Logout();
        Nav.NavigateTo("/authentication", true);
    }

    async Task UpdateAccount()
    {
        if (Auth.CurrentUser == null) return;
        
        AccountMessage = "";
        AccountIsSuccess = false;

        if (string.IsNullOrWhiteSpace(EditUsername) || string.IsNullOrWhiteSpace(EditEmail))
        {
            AccountMessage = "Username and Email are required.";
            return;
        }

        try 
        {
            var user = Db.Users.Find(Auth.CurrentUser.Id);
            if (user != null)
            {
                // Check if username/email already taken by someone else
                var existing = Db.Users.Any(u => u.Id != user.Id && (u.Username.ToLower() == EditUsername.ToLower() || u.Email.ToLower() == EditEmail.ToLower()));
                if (existing)
                {
                    AccountMessage = "Username or Email already in use.";
                    return;
                }

                user.Username = EditUsername;
                user.Email = EditEmail;
                
                if (!string.IsNullOrWhiteSpace(EditPassword))
                {
                    user.PasswordHash = PinService.HashPin(EditPassword);
                }

                user.UpdatedAt = DateTime.Now;

                await Db.SaveChangesAsync();
                
                // Refresh local session
                Auth.Login(user);
                
                AccountMessage = "Profile updated successfully.";
                AccountIsSuccess = true;
                EditPassword = ""; // Clear password field
            }
        }
        catch (Exception ex)
        {
            AccountMessage = "Error updating profile: " + ex.Message;
        }
    }
}
