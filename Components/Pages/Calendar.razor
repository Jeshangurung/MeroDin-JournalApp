@page "/calendar"
@using Journal.Data
@using Journal.Entities
@using Microsoft.EntityFrameworkCore



@inject AppDbContext Db
@inject NavigationManager Nav
@inject AuthStateService Auth
@inject Journal.Services.IJournalService JournalService

<h3>Calendar</h3>

<main class="calendar-container">

    <!-- Header -->
    <div class="calendar-header">
        <div class="month-navigation">
            <button class="nav-arrow" @onclick="PrevMonth">
                ‹
            </button>

            <h2 class="month-display">
                @CurrentMonth.ToString("MMMM yyyy")
            </h2>

            <button class="nav-arrow" @onclick="NextMonth">
                ›
            </button>
        </div>

        <button class="today-btn" @onclick="GoToToday">
            Today
        </button>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <div class="calendar-header-row">
            @foreach (var day in WeekDays)
            {
                <div class="day-header">@day</div>
            }
        </div>

        <div class="calendar-body">
            @foreach (var day in CalendarDays)
            {
                <div class="calendar-day
                         @(day.IsOtherMonth ? "other-month" : "")
                         @(day.HasEntry ? "has-entry" : "")
                         @(day.Date.Date == DateTime.Today ? "today" : "")"
                     @onclick="() => OpenEntry(day)">

                    <span class="day-number">@day.Date.Day</span>

                    @if (day.HasEntry)
                    {
                        <div class="entry-indicator">
                            @day.MoodEmoji
                        </div>
                    }
                </div>
            }
        </div>
    </div>

</main>

@code {
    DateTime CurrentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);

    readonly string[] WeekDays = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    List<CalendarDay> CalendarDays = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCalendar();
    }

    async Task PrevMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        await LoadCalendar();
    }

    async Task NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        await LoadCalendar();
    }

    async Task GoToToday()
    {
        CurrentMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        await LoadCalendar();
    }

    /// <summary>
    /// Loads entries for the currently selected month and populates the calendar grid.
    /// Filters entries by the currently authenticated user for data isolation.
    /// </summary>
    private async Task LoadCalendar()
    {
        if (Auth.CurrentUser == null) return;

        CalendarDays.Clear();

        var firstDay = CurrentMonth;
        var startDay = firstDay.AddDays(-(int)firstDay.DayOfWeek);

        // Fetch user entries for the selected month
        var entries = await Db.JournalEntries
            .Where(e => e.UserId == Auth.CurrentUser.Id &&
                        e.EntryDate.Month == CurrentMonth.Month &&
                        e.EntryDate.Year == CurrentMonth.Year)
            .ToListAsync();

        for (int i = 0; i < 42; i++)
        {
            var date = startDay.AddDays(i);
            var entry = entries.FirstOrDefault(e => e.EntryDate.Date == date.Date);

            CalendarDays.Add(new CalendarDay
            {
                Date = date,
                IsOtherMonth = date.Month != CurrentMonth.Month,
                HasEntry = entry != null,
                MoodEmoji = entry != null ? GetMoodEmoji(entry.PrimaryMood) : ""
            });
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Navigates to the editor for the selected day.
    /// Redirects to existing entry if available, or creates a new entry context.
    /// </summary>
    private void OpenEntry(CalendarDay day)
    {
        try
        {
            if (!day.HasEntry) return;

            // Navigate to the write page with the specific date context
            Nav.NavigateTo($"/write?date={day.Date:yyyy-MM-dd}");
        }
        catch (Exception)
        {
            // Log navigation error if necessary
        }
    }

    /// <summary>
    /// Maps the stored primary mood string to its corresponding emoji for visual display.
    /// Handles cases where the stored string might contain the emoji prefix.
    /// </summary>
    private string GetMoodEmoji(string mood)
    {
        if (string.IsNullOrEmpty(mood)) return "📝";

        // Check for specific icons within the stored string
        if (mood.Contains("😊") || mood.Contains("Happy")) return "😊";
        if (mood.Contains("🤩") || mood.Contains("Excited")) return "🤩";
        if (mood.Contains("😌") || mood.Contains("Relaxed")) return "😌";
        if (mood.Contains("🙏") || mood.Contains("Grateful")) return "🙏";
        if (mood.Contains("⭐") || mood.Contains("Confident")) return "⭐";
        if (mood.Contains("😐") || mood.Contains("Calm")) return "😐";
        if (mood.Contains("🤔") || mood.Contains("Thoughtful")) return "🤔";
        if (mood.Contains("😢") || mood.Contains("Sad")) return "😢";
        if (mood.Contains("😠") || mood.Contains("Angry")) return "😠";
        if (mood.Contains("😰") || mood.Contains("Stressed")) return "😰";
        if (mood.Contains("😟") || mood.Contains("Anxious")) return "😟";
        
        return "📝";
    }

    class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsOtherMonth { get; set; }
        public bool HasEntry { get; set; }
        public string MoodEmoji { get; set; } = "";
    }
}
